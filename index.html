<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WesBI Beast Mode - FBA Intelligence Cockpit</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><polygon points='8,0 16,16 0,16' fill='%239c4dff'/></svg>">
<style>
:root {
  --primary: #9c4dff;
  --primary-dark: #7a33ff;
  --secondary: #6c34ff;
  --success: #2ecc71;
  --warning: #f39c12;
  --danger: #e74c3c;
  --light: #f8f9fa;
  --dark: #212529;
  --gray: #6c757d;
  --border: #dee2e6;
  --card-bg: #ffffff;
  --bg: #f5f7fa;
  --shadow: 0 4px 20px rgba(0,0,0,0.08);
  --transition: all 0.3s ease;
  --diff-green: #d4edda;
  --diff-red: #f8d7da;
  --diff-gray: #e2e3e5;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--dark);
  line-height: 1.6;
  padding: 20px;
  min-height: 100vh;
}
.container { 
  max-width: 1400px; 
  margin: 0 auto; 
  background: var(--card-bg); 
  border-radius: 16px; 
  box-shadow: var(--shadow); 
  overflow: hidden; 
  position: relative; 
}
.header { 
  background: linear-gradient(135deg, var(--primary), var(--secondary)); 
  color: white; 
  padding: 30px; 
  text-align: center; 
}
.header h1 { 
  font-size: 2.5rem; 
  margin-bottom: 10px; 
  font-weight: 700;
}
.header p { 
  font-size: 1.1rem; 
  opacity: 0.9; 
  max-width: 700px; 
  margin: 0 auto; 
}
.controls { 
  padding: 25px 30px; 
  background: var(--light); 
  display: flex; 
  flex-wrap: wrap; 
  gap: 15px; 
  align-items: center; 
  border-bottom: 1px solid var(--border); 
}
.file-upload { 
  display: flex; 
  flex: 1; 
  min-width: 250px; 
  position: relative; 
}
.file-upload input[type="file"] { 
  flex: 1; 
  padding: 12px 12px 12px 120px; 
  border: 2px dashed var(--border); 
  border-radius: 8px; 
  font-size: 1rem; 
  cursor: pointer;
  background: white;
}
.file-upload input[type="file"]::file-selector-button {
  position: absolute;
  left: 2px;
  top: 2px;
  height: calc(100% - 4px);
  border: 0;
  border-radius: 6px;
  background: var(--primary);
  color: white;
  padding: 0 16px;
  margin-right: 10px;
  cursor: pointer;
  font-weight: 600;
}
.file-upload input[type="file"]:hover::file-selector-button {
  background: var(--primary-dark);
}
.btn { 
  padding: 12px 24px; 
  border: none; 
  border-radius: 8px; 
  cursor: pointer; 
  font-weight: 600; 
  transition: var(--transition); 
  display: inline-flex; 
  align-items: center; 
  gap: 8px; 
  white-space: nowrap;
}
.btn-primary { 
  background: var(--primary); 
  color: white; 
}
.btn-primary:hover { 
  background: var(--primary-dark); 
  transform: translateY(-2px); 
}
.btn-success { 
  background: var(--success); 
  color: white; 
}
.btn-success:hover { 
  background: #27ae60; 
}
.btn-secondary { 
  background: var(--secondary); 
  color: white; 
}
.btn-secondary:hover { 
  background: #5a26d8; 
}
.btn-compare { 
  background: #3498db; 
  color: white; 
}
.btn-compare:hover { 
  background: #2980b9; 
}
.btn-alert { 
  background: var(--danger); 
  color: white; 
}
.btn-alert:hover { 
  background: #c0392b; 
}
.stats-container { 
  display: grid; 
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
  gap: 20px; 
  padding: 20px 30px; 
  background: var(--light); 
  border-bottom: 1px solid var(--border); 
}
.stat-card { 
  background: white; 
  border-radius: 12px; 
  padding: 20px; 
  text-align: center; 
  box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
  border-left: 4px solid var(--primary); 
  position: relative; 
  cursor: pointer; 
  transition: var(--transition); 
  min-height: 140px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.stat-card:hover { 
  transform: translateY(-3px); 
  box-shadow: 0 6px 16px rgba(0,0,0,0.1); 
}
.stat-value { 
  font-size: 2rem; 
  font-weight: 700; 
  color: var(--primary); 
  margin: 10px 0; 
}
.stat-label { 
  font-size: 0.85rem; 
  color: var(--gray); 
  margin-bottom: 8px;
}
.stat-change { 
  font-size: 0.8rem; 
  padding: 2px 10px; 
  border-radius: 15px; 
  margin-top: 5px; 
  display: inline-block; 
  font-weight: 600;
}
.change-up { 
  background: rgba(46, 204, 113, 0.2); 
  color: var(--success); 
}
.change-down { 
  background: rgba(231, 76, 60, 0.2); 
  color: var(--danger); 
}
.change-neutral { 
  background: rgba(108, 117, 125, 0.2); 
  color: var(--gray); 
}
.sparkline { 
  height: 30px; 
  margin-top: 10px; 
  display: flex; 
  align-items: end; 
  gap: 2px; 
}
.spark-bar { 
  flex: 1; 
  min-width: 3px; 
  background: var(--primary);
  border-radius: 2px 2px 0 0;
}
.spark-bar.up { background: var(--success); }
.spark-bar.down { background: var(--danger); }
.charts-container { 
  display: grid; 
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
  gap: 20px; 
  padding: 20px 30px; 
  background: var(--light); 
  border-bottom: 1px solid var(--border); 
}
.chart-card { 
  background: white; 
  border-radius: 12px; 
  padding: 15px; 
  box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
}
.chart-title { 
  font-size: 1rem; 
  font-weight: 600; 
  margin-bottom: 10px; 
  color: var(--dark); 
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.chart-title .chart-actions {
  display: flex;
  gap: 8px;
}
.chart-container { 
  height: 220px; 
  position: relative; 
}
.table-container { 
  padding: 20px; 
  overflow-x: auto; 
}
table { 
  width: 100%; 
  border-collapse: collapse; 
  min-width: 1200px; 
  box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
}
th, td { 
  padding: 14px 12px; 
  text-align: left; 
  border-bottom: 1px solid var(--border); 
  vertical-align: top;
}
th { 
  background: #f1f3f9; 
  position: sticky; 
  top: 0; 
  z-index: 10; 
  cursor: pointer; 
  user-select: none; 
  font-weight: 600; 
  color: var(--dark); 
  text-transform: uppercase; 
  font-size: 0.8rem; 
  letter-spacing: 0.5px; 
  line-height: 1.2;
}
th:hover { 
  background: #e6e9f5; 
}
th.sort-asc::after { 
  content: " ‚ñ≤"; 
  color: var(--primary); 
}
th.sort-desc::after { 
  content: " ‚ñº"; 
  color: var(--primary); 
}
tr:nth-child(even) { 
  background-color: #fafbff; 
}
tr:hover { 
  background-color: #f0f4ff; 
}
.diff-increase { background-color: var(--diff-green) !important; }
.diff-decrease { background-color: var(--diff-red) !important; }
.diff-unchanged { background-color: var(--diff-gray) !important; }
.highlight { 
  background-color: #fff8e1 !important; 
  animation: pulse 2s infinite; 
}
.status-warning { 
  background-color: #fff3cd !important; 
  animation: pulseWarning 3s infinite; 
}
.status-at-risk { 
  background-color: #f8d7da !important; 
  border-left: 4px solid var(--danger);
}
.status-hot { 
  background-color: #d4edda !important; 
  border-left: 4px solid var(--success);
}
@keyframes pulse { 
  0% { background-color: #fff8e1; } 
  50% { background-color: #fff0c1; } 
  100% { background-color: #fff8e1; } 
}
@keyframes pulseWarning { 
  0% { background-color: #fff3cd; } 
  50% { background-color: #ffeaa7; } 
  100% { background-color: #fff3cd; } 
}
.status-badge { 
  display: inline-block; 
  padding: 4px 10px; 
  border-radius: 20px; 
  font-size: 0.75rem; 
  font-weight: 600; 
}
.status-recommendation { 
  background: #ffebee; 
  color: var(--danger); 
}
.status-normal { 
  background: #e8f5e9; 
  color: var(--success); 
}
.status-warning-badge { 
  background: #fff3cd; 
  color: #856404; 
}
.sku-cell { 
  font-family: monospace; 
  font-weight: 600; 
  color: var(--primary); 
  min-width: 120px;
}
.asin-cell { 
  font-family: monospace; 
  color: var(--secondary); 
  min-width: 100px;
}
.product-cell { 
  min-width: 200px;
  max-width: 300px;
  word-wrap: break-word;
}
.numeric-cell {
  text-align: right;
  font-family: monospace;
}
.pagination { 
  display: flex; 
  justify-content: center; 
  padding: 20px; 
  gap: 10px; 
  flex-wrap: wrap; 
}
.page-btn { 
  padding: 8px 14px; 
  border: 1px solid var(--border); 
  background: white; 
  cursor: pointer; 
  border-radius: 6px; 
  transition: var(--transition); 
}
.page-btn.active { 
  background: var(--primary); 
  color: white; 
  border-color: var(--primary); 
}
.page-btn:hover:not(.active) { 
  background: #f0f0f0; 
}
.search-box { 
  flex: 1; 
  min-width: 200px; 
  padding: 12px 15px; 
  border: 2px solid var(--border); 
  border-radius: 8px; 
  font-size: 1rem; 
}
.filter-controls { 
  display: flex; 
  gap: 10px; 
  flex-wrap: wrap; 
  align-items: center;
}
.advanced-filters {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
  padding-top: 15px;
  border-top: 1px solid var(--border);
}
.advanced-filters select, .advanced-filters input {
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  font-size: 0.9rem;
  min-width: 120px;
}
.empty-state { 
  text-align: center; 
  padding: 60px 20px; 
  color: var(--gray); 
}
.empty-state i { 
  font-size: 3rem; 
  margin-bottom: 20px; 
  opacity: 0.3; 
}
.loader-overlay { 
  position: absolute; 
  top:0; 
  left:0; 
  width:100%; 
  height:100%; 
  background:rgba(255,255,255,0.9); 
  display:flex; 
  justify-content:center; 
  align-items:center; 
  font-size:1.5rem; 
  color: var(--primary); 
  display:none; 
  z-index:100; 
  flex-direction: column;
  gap: 15px;
}
.alert-banner {
  background: linear-gradient(135deg, var(--warning), #e67e22);
  color: white;
  padding: 12px 20px;
  text-align: center;
  font-weight: 600;
  animation: slideIn 0.5s ease;
}
@keyframes slideIn {
  from { transform: translateY(-100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.insights-panel {
  background: var(--light);
  padding: 20px 30px;
  border-bottom: 1px solid var(--border);
}
.insights-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 15px;
  color: var(--dark);
}
.insight-item {
  background: white;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  border-left: 3px solid var(--primary);
}
.insight-item.at-risk {
  border-left-color: var(--danger);
}
.insight-item.hot {
  border-left-color: var(--success);
}
.insight-item strong {
  color: var(--primary);
}
.comparison-view {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  text-align: center;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 8px;
  display: none;
}
.comparison-title {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 10px;
}
.comparison-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 10px;
}
@media (max-width: 768px) {
  .header h1 { font-size: 1.8rem; }
  .controls, .advanced-filters { 
    flex-direction: column; 
    align-items: stretch; 
  }
  .file-upload { width: 100%; }
  .btn { width: 100%; justify-content: center; }
  .stats-container { grid-template-columns: 1fr; }
  .charts-container { grid-template-columns: 1fr; }
  .chart-container { height: 180px; }
  th, td { padding: 10px 8px; font-size: 0.75rem; }
  .product-cell { min-width: 150px; max-width: 200px; }
  .numeric-cell { padding: 10px 6px; }
}
</style>
</head>
<body>
<div class="container">
  <div class="loader-overlay" id="loader">
    <div>‚ö° Processing your data...</div>
    <div id="loaderProgress">0%</div>
  </div>
  
  <div class="header">
    <h1>ü¶Å WesBI Beast Mode</h1>
    <p>FBA Intelligence Cockpit - Real-time Amazon Ops Analytics</p>
  </div>
  
  <div class="comparison-view" id="comparisonView">
    <div class="comparison-title">üìä Snapshot Comparison Mode</div>
    <div id="comparisonInfo">Comparing two snapshots</div>
    <div class="comparison-actions">
      <button id="exitComparisonBtn" class="btn btn-secondary">Exit Comparison</button>
    </div>
  </div>
  
  <div class="controls">
    <div class="file-upload">
      <input type="file" id="csvFile" accept=".csv" multiple>
    </div>
    <button id="processBtn" class="btn btn-primary">üöÄ Process Snapshots</button>
    <button id="compareBtn" class="btn btn-compare">üîÑ Compare Snapshots</button>
    <button id="alertsBtn" class="btn btn-alert">üö® View Alerts</button>
    <button id="exportBtn" class="btn btn-success">üì§ Export Data</button>
  </div>
  
  <div class="controls">
    <input type="text" id="searchInput" class="search-box" placeholder="üîç Search by SKU, ASIN, or Product Name...">
    <div class="filter-controls">
      <select id="conditionFilter">
        <option value="">All Conditions</option>
        <option value="New">New</option>
        <option value="Used">Used</option>
      </select>
      <select id="actionFilter">
        <option value="">All Actions</option>
        <option value="removal">Recommended Removal</option>
        <option value="normal">No Action</option>
      </select>
      <select id="ageFilter">
        <option value="">All Age Brackets</option>
        <option value="0-90">0-90 days</option>
        <option value="91-180">91-180 days</option>
        <option value="181-365">181-365 days</option>
        <option value="365+">365+ days</option>
      </select>
      <button id="resetFilters" class="btn btn-secondary">Reset</button>
    </div>
  </div>
  
  <div class="advanced-filters">
    <select id="categoryFilter">
      <option value="">All Categories</option>
    </select>
    <input type="number" id="minStockFilter" placeholder="Min Stock" min="0">
    <input type="number" id="maxStockFilter" placeholder="Max Stock" min="0">
    <select id="stockStatusFilter">
      <option value="">Stock Status</option>
      <option value="low">Low Stock</option>
      <option value="high">High Stock</option>
      <option value="stranded">Stranded</option>
    </select>
  </div>
  
  <div class="insights-panel" id="insightsPanel" style="display:none;">
    <div class="insights-title">üí° AI-Powered Insights</div>
    <div id="insightsContent"></div>
  </div>
  
  <div class="stats-container" id="statsContainer">
    <div class="stat-card" data-filter="totalProducts">
      <div class="stat-label">Total Products</div>
      <div class="stat-value" id="totalProducts">0</div>
      <div class="stat-change change-up" id="productsChange">+0%</div>
      <div class="sparkline" id="productsSparkline"></div>
    </div>
    <div class="stat-card" data-filter="availableInventory">
      <div class="stat-label">Available Inventory</div>
      <div class="stat-value" id="availableInventory">0</div>
      <div class="stat-change change-up" id="inventoryChange">+0%</div>
      <div class="sparkline" id="inventorySparkline"></div>
    </div>
    <div class="stat-card" data-filter="pendingRemovals">
      <div class="stat-label">Pending Removals</div>
      <div class="stat-value" id="pendingRemovals">0</div>
      <div class="stat-change change-down" id="pendingChange">-0%</div>
      <div class="sparkline" id="pendingSparkline"></div>
    </div>
    <div class="stat-card" data-filter="sellThroughRate">
      <div class="stat-label">Sell-Through Rate</div>
      <div class="stat-value" id="sellThroughRate">0%</div>
      <div class="stat-change change-up" id="sellThroughChange">+0%</div>
      <div class="sparkline" id="sellThroughSparkline"></div>
    </div>
    <div class="stat-card" data-filter="avgDaysInventory">
      <div class="stat-label">Avg Days in Inventory</div>
      <div class="stat-value" id="avgDaysInventory">0</div>
      <div class="stat-change change-down" id="daysChange">-0%</div>
      <div class="sparkline" id="daysSparkline"></div>
    </div>
    <div class="stat-card" data-filter="atRiskSKUs">
      <div class="stat-label">At-Risk SKUs</div>
      <div class="stat-value" id="atRiskSKUs">0</div>
      <div class="stat-change change-up" id="riskChange">+0%</div>
      <div class="sparkline" id="riskSparkline"></div>
    </div>
  </div>
  
  <div class="charts-container" id="chartsContainer">
    <div class="chart-card">
      <div class="chart-title">
        <span>Inventory Age Distribution</span>
        <div class="chart-actions">
          <button class="btn btn-secondary" data-chart="age">Export</button>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="ageChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">
        <span>Top At-Risk SKUs</span>
        <div class="chart-actions">
          <button class="btn btn-secondary" data-chart="risk">Export</button>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="riskChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">
        <span>Sell-Through Performance</span>
        <div class="chart-actions">
          <button class="btn btn-secondary" data-chart="performance">Export</button>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="performanceChart"></canvas>
      </div>
    </div>
  </div>
  
  <div class="table-container">
    <table id="dashboardTable">
      <thead>
        <tr>
          <th data-sort="sku">SKU</th>
          <th data-sort="asin">ASIN</th>
          <th data-sort="name">Product Name</th>
          <th data-sort="condition">Condition</th>
          <th data-sort="available" class="numeric">Available</th>
          <th data-sort="pendingRemoval" class="numeric">Pending Removal</th>
          <th data-sort="totalInvAge" class="numeric">Total Inventory Age</th>
          <th data-sort="shippedT30" class="numeric">Units Shipped T30</th>
          <th data-sort="sellThroughRate" class="numeric">Sell-Through Rate</th>
          <th data-sort="recommendedAction">Recommended Action</th>
          <th data-sort="riskScore">Risk Score</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr>
          <td colspan="11" class="empty-state">
            <div>üìÅ Upload FBA Snapshot CSV files to get started</div>
            <div style="margin-top: 10px; font-size: 0.9rem; color: var(--gray);">
              Support for multiple files for comparison analysis
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <div class="pagination" id="paginationContainer"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
class WesBIBeastMode {
  constructor() {
    this.snapshots = {};
    this.currentData = [];
    this.filteredData = [];
    this.comparisonMode = false;
    this.comparisonData = null;
    this.currentPage = 1;
    this.itemsPerPage = 30;
    this.sortColumn = null;
    this.sortDirection = 'asc';
    this.alerts = [];
    this.init();
  }
  
  init() {
    this.loader = document.getElementById('loader');
    document.getElementById('processBtn').addEventListener('click', () => this.processCSVs());
    document.getElementById('compareBtn').addEventListener('click', () => this.toggleComparisonMode());
    document.getElementById('alertsBtn').addEventListener('click', () => this.showAlerts());
    document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
    document.getElementById('exitComparisonBtn').addEventListener('click', () => this.exitComparisonMode());
    document.getElementById('searchInput').addEventListener('input', () => this.applyFilters());
    document.getElementById('resetFilters').addEventListener('click', () => this.resetFilters());
    document.querySelectorAll('.filter-controls select, .advanced-filters select, .advanced-filters input').forEach(el => {
      el.addEventListener('change', () => this.applyFilters());
    });
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => this.sortTable(th.dataset.sort));
    });
    document.querySelectorAll('.stat-card').forEach(card => {
      card.addEventListener('click', () => this.filterByCard(card.dataset.filter));
    });
    document.querySelectorAll('[data-chart]').forEach(btn => {
      btn.addEventListener('click', (e) => this.exportChart(e.target.dataset.chart));
    });
  }

  showLoader(show, message = "Processing...") {
    const loader = document.getElementById('loader');
    loader.querySelector('div:first-child').textContent = message;
    loader.style.display = show ? 'flex' : 'none';
  }

  updateProgress(percent) {
    document.getElementById('loaderProgress').textContent = `${percent}%`;
  }

  async processCSVs() {
    const files = document.getElementById('csvFile').files;
    if (files.length === 0) return alert("Please select CSV file(s) first!");
    
    this.showLoader(true, "Processing your FBA snapshots...");
    this.updateProgress(0);
    
    try {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileName = file.name.replace('.csv', '');
        this.updateProgress(Math.round((i / files.length) * 100));
        
        await new Promise((resolve, reject) => {
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              const ageKeys = ['inv-age-0-to-90-days','inv-age-91-to-180-days','inv-age-181-to-270-days','inv-age-271-to-365-days','inv-age-365-plus-days'];
              const processedData = results.data.map(row => {
                const totalInvAge = ageKeys.reduce((sum,k) => sum + Number(row[k] || 0), 0);
                const available = Number(row['available'] || 0);
                const shippedT30 = Number(row['units-shipped-t30'] || 0);
                const sellThroughRate = available > 0 ? Math.round((shippedT30 / (available + shippedT30)) * 100) : 0;
                const riskScore = this.calculateRiskScore(available, totalInvAge, shippedT30);
                
                return {
                  sku: row['sku'] || '',
                  asin: row['asin'] || '',
                  name: row['product-name'] || '',
                  condition: row['condition'] || '',
                  available: available,
                  pendingRemoval: Number(row['pending-removal-quantity'] || 0),
                  totalInvAge: totalInvAge,
                  shippedT30: shippedT30,
                  sellThroughRate: sellThroughRate,
                  recommendedAction: row['recommended-action'] || 'No Action',
                  riskScore: riskScore,
                  category: row['category'] || 'Unknown',
                  timestamp: new Date().toISOString()
                };
              });
              
              this.snapshots[fileName] = {
                data: processedData,
                timestamp: new Date().toISOString(),
                stats: this.calculateStats(processedData)
              };
              resolve();
            },
            error: (error) => {
              console.error('CSV parsing error:', error);
              reject(error);
            }
          });
        });
      }
      
      // Set current data to the most recent snapshot
      const snapshotNames = Object.keys(this.snapshots);
      if (snapshotNames.length > 0) {
        const latestSnapshot = snapshotNames[snapshotNames.length - 1];
        this.currentData = [...this.snapshots[latestSnapshot].data];
        this.filteredData = [...this.currentData];
        this.generateAlerts();
        this.updateUI();
        this.showLoader(false);
        alert(`‚úÖ Processed ${snapshotNames.length} snapshot(s) with ${this.currentData.length} total products!`);
      }
    } catch (error) {
      console.error('Error processing CSVs:', error);
      alert('Error processing CSV files. Please check the file format.');
      this.showLoader(false);
    }
  }

  calculateStats(data) {
    const totalProducts = data.length;
    const totalAvailable = data.reduce((sum, i) => sum + i.available, 0);
    const totalPending = data.reduce((sum, i) => sum + i.pendingRemoval, 0);
    const totalShipped = data.reduce((sum, i) => sum + i.shippedT30, 0);
    const avgDaysInventory = totalProducts > 0 ? Math.round(data.reduce((sum, i) => sum + i.totalInvAge, 0) / totalProducts) : 0;
    const sellThroughRate = totalAvailable + totalShipped > 0 ? Math.round((totalShipped / (totalAvailable + totalShipped)) * 100) : 0;
    const atRiskSKUs = data.filter(i => i.riskScore > 70).length;
    
    return {
      totalProducts,
      totalAvailable,
      totalPending,
      totalShipped,
      avgDaysInventory,
      sellThroughRate,
      atRiskSKUs
    };
  }

  calculateRiskScore(available, totalInvAge, shippedT30) {
    let score = 0;
    
    // High inventory age increases risk
    if (totalInvAge > 365) score += 40;
    else if (totalInvAge > 180) score += 25;
    else if (totalInvAge > 90) score += 10;
    
    // Low sell-through increases risk
    const sellThroughRate = available + shippedT30 > 0 ? (shippedT30 / (available + shippedT30)) * 100 : 0;
    if (sellThroughRate < 10) score += 30;
    else if (sellThroughRate < 25) score += 20;
    else if (sellThroughRate < 50) score += 10;
    
    // High pending removals increase risk
    if (this.pendingRemoval > 10) score += 20;
    else if (this.pendingRemoval > 5) score += 10;
    
    // Low available stock with high demand could be risk (stockout)
    if (available < 5 && shippedT30 > 20) score += 15;
    
    return Math.min(score, 100);
  }

  generateAlerts() {
    this.alerts = [];
    
    // Find at-risk SKUs
    const atRiskSKUs = this.currentData.filter(item => item.riskScore > 70);
    atRiskSKUs.slice(0, 5).forEach(sku => {
      this.alerts.push({
        type: 'at-risk',
        message: `‚ö†Ô∏è SKU ${sku.sku} is at high risk (Score: ${sku.riskScore}). Consider removal or promotional action.`,
        sku: sku.sku
      });
    });
    
    // Find hot SKUs
    const hotSKUs = this.currentData.filter(item => 
      item.sellThroughRate > 70 && item.available > 0 && item.totalInvAge < 90
    );
    hotSKUs.slice(0, 3).forEach(sku => {
      this.alerts.push({
        type: 'hot',
        message: `üî• SKU ${sku.sku} is trending hot! Sell-through rate: ${sku.sellThroughRate}%. Consider restocking.`,
        sku: sku.sku
      });
    });
    
    // Low stock alerts
    const lowStock = this.currentData.filter(item => item.available < 10 && item.shippedT30 > 5);
    lowStock.slice(0, 3).forEach(sku => {
      this.alerts.push({
        type: 'low-stock',
        message: `üìä SKU ${sku.sku} has low stock (${sku.available} units) with high demand (${sku.shippedT30} units shipped). Restock needed!`,
        sku: sku.sku
      });
    });
    
    this.updateInsightsPanel();
  }

  updateInsightsPanel() {
    const panel = document.getElementById('insightsPanel');
    const content = document.getElementById('insightsContent');
    
    if (this.alerts.length > 0) {
      content.innerHTML = this.alerts.map(alert => {
        const className = alert.type === 'at-risk' ? 'at-risk' : alert.type === 'hot' ? 'hot' : '';
        return `<div class="insight-item ${className}">${alert.message}</div>`;
      }).join('');
      panel.style.display = 'block';
    } else {
      panel.style.display = 'none';
    }
  }

  updateUI() {
    this.updateStats();
    this.renderCharts();
    this.renderTable();
    this.renderPagination();
  }

  updateStats() {
    if (this.filteredData.length === 0) {
      // Reset all stats to 0
      document.getElementById('totalProducts').textContent = '0';
      document.getElementById('availableInventory').textContent = '0';
      document.getElementById('pendingRemovals').textContent = '0';
      document.getElementById('sellThroughRate').textContent = '0%';
      document.getElementById('avgDaysInventory').textContent = '0';
      document.getElementById('atRiskSKUs').textContent = '0';
      return;
    }
    
    const stats = this.calculateStats(this.filteredData);
    
    document.getElementById('totalProducts').textContent = stats.totalProducts.toLocaleString();
    document.getElementById('availableInventory').textContent = stats.totalAvailable.toLocaleString();
    document.getElementById('pendingRemovals').textContent = stats.totalPending.toLocaleString();
    document.getElementById('sellThroughRate').textContent = `${stats.sellThroughRate}%`;
    document.getElementById('avgDaysInventory').textContent = stats.avgDaysInventory;
    document.getElementById('atRiskSKUs').textContent = stats.atRiskSKUs;
    
    // Mock changes (in real implementation, compare with previous snapshot)
    document.getElementById('productsChange').textContent = '+2.3%';
    document.getElementById('inventoryChange').textContent = '+5.1%';
    document.getElementById('pendingChange').textContent = '-12.5%';
    document.getElementById('sellThroughChange').textContent = '+8.2%';
    document.getElementById('daysChange').textContent = '-3.1%';
    document.getElementById('riskChange').textContent = '-5.4%';
    
    this.renderSparklines();
  }

  renderSparklines() {
    const sparklineData = {
      products: [45, 52, 48, 60, 58, 65, 70],
      inventory: [1800, 2100, 1950, 2200, 2400, 2300, 2500],
      pending: [45, 38, 42, 35, 30, 28, 25],
      sellThrough: [65, 68, 70, 72, 75, 78, 80],
      days: [120, 115, 118, 110, 105, 102, 98],
      risk: [25, 28, 24, 22, 20, 18, 15]
    };
    
    Object.entries(sparklineData).forEach(([key, data]) => {
      const container = document.getElementById(`${key}Sparkline`);
      if (!container) return;
      
      container.innerHTML = '';
      const maxValue = Math.max(...data);
      const minValue = Math.min(...data);
      
      data.forEach((value, index) => {
        const height = ((value - minValue) / (maxValue - minValue)) * 100;
        const isUp = index > 0 && value > data[index - 1];
        const isDown = index > 0 && value < data[index - 1];
        const barClass = isUp ? 'up' : isDown ? 'down' : '';
        container.innerHTML += `<div class="spark-bar ${barClass}" style="height:${Math.max(height, 5)}%"></div>`;
      });
    });
  }

  renderCharts() {
    // Destroy existing charts
    if (this.chartInstances) {
      Object.values(this.chartInstances).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') chart.destroy();
      });
    }
    this.chartInstances = {};
    
    if (this.currentData.length === 0) return;
    
    // Age distribution chart
    const ageCtx = document.getElementById('ageChart').getContext('2d');
    this.chartInstances.ageChart = new Chart(ageCtx, {
      type: 'doughnut',
      data: {
        labels: ['0-90 days', '91-180 days', '181-270 days', '271-365 days', '365+ days'],
        datasets: [{
          data: this.getAgeDistribution(),
          backgroundColor: ['#2ecc71', '#3498db', '#f39c12', '#e67e22', '#e74c3c'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { padding: 15 } },
          tooltip: {
            callbacks: {
              label: (context) => `${context.label}: ${context.raw} products (${((context.raw / context.dataset.data.reduce((a,b) => a + b, 0)) * 100).toFixed(1)}%)`
            }
          }
        }
      }
    });
    
    // Top at-risk SKUs chart
    const riskData = this.getTopAtRiskSKUs();
    const riskCtx = document.getElementById('riskChart').getContext('2d');
    this.chartInstances.riskChart = new Chart(riskCtx, {
      type: 'bar',
      data: {
        labels: riskData.labels,
        datasets: [{
          data: riskData.values,
          backgroundColor: '#e74c3c',
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (context) => `Risk Score: ${context.raw}`
            }
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            max: 100,
            ticks: { stepSize: 20 }
          }
        }
      }
    });
    
    // Sell-through performance chart
    const perfData = this.getSellThroughDistribution();
    const perfCtx = document.getElementById('performanceChart').getContext('2d');
    this.chartInstances.performanceChart = new Chart(perfCtx, {
      type: 'bar',
      data: {
        labels: perfData.labels,
        datasets: [{
          data: perfData.values,
          backgroundColor: perfData.colors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (context) => `Sell-Through: ${context.raw}%`
            }
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            max: 100,
            ticks: { stepSize: 25 }
          }
        }
      }
    });
  }

  getAgeDistribution() {
    const counts = [0, 0, 0, 0, 0];
    this.currentData.forEach(item => {
      if (item.totalInvAge <= 90) counts[0]++;
      else if (item.totalInvAge <= 180) counts[1]++;
      else if (item.totalInvAge <= 270) counts[2]++;
      else if (item.totalInvAge <= 365) counts[3]++;
      else counts[4]++;
    });
    return counts;
  }

  getTopAtRiskSKUs() {
    const atRisk = this.currentData
      .filter(item => item.riskScore > 50)
      .sort((a, b) => b.riskScore - a.riskScore)
      .slice(0, 8);
    
    return {
      labels: atRisk.map(item => item.sku.length > 8 ? item.sku.substring(0, 8) + '...' : item.sku),
      values: atRisk.map(item => item.riskScore)
    };
  }

  getSellThroughDistribution() {
    const sorted = this.currentData
      .filter(item => item.sellThroughRate > 0)
      .sort((a, b) => b.sellThroughRate - a.sellThroughRate)
      .slice(0, 10);
    
    return {
      labels: sorted.map(item => item.sku.length > 8 ? item.sku.substring(0, 8) + '...' : item.sku),
      values: sorted.map(item => item.sellThroughRate),
      colors: sorted.map(item => {
        if (item.sellThroughRate >= 70) return '#2ecc71';
        else if (item.sellThroughRate >= 50) return '#f39c12';
        else return '#e74c3c';
      })
    };
  }

  applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
    const condition = document.getElementById('conditionFilter').value;
    const action = document.getElementById('actionFilter').value;
    const ageBracket = document.getElementById('ageFilter').value;
    const category = document.getElementById('categoryFilter').value;
    const minStock = document.getElementById('minStockFilter').value;
    const maxStock = document.getElementById('maxStockFilter').value;
    const stockStatus = document.getElementById('stockStatusFilter').value;
    
    this.filteredData = this.currentData.filter(item => {
      // Search filter
      const matchesSearch = !searchTerm || 
        item.sku.toLowerCase().includes(searchTerm) ||
        item.asin.toLowerCase().includes(searchTerm) ||
        item.name.toLowerCase().includes(searchTerm);
      
      // Condition filter
      const matchesCondition = !condition || item.condition === condition;
      
      // Action filter
      const matchesAction = !action || 
        (action === 'removal' && item.recommendedAction.toLowerCase().includes('removal')) ||
        (action === 'normal' && !item.recommendedAction.toLowerCase().includes('removal'));
      
      // Age bracket filter
      let matchesAge = true;
      if (ageBracket) {
        switch(ageBracket) {
          case '0-90': matchesAge = item.totalInvAge <= 90; break;
          case '91-180': matchesAge = item.totalInvAge > 90 && item.totalInvAge <= 180; break;
          case '181-365': matchesAge = item.totalInvAge > 180 && item.totalInvAge <= 365; break;
          case '365+': matchesAge = item.totalInvAge > 365; break;
        }
      }
      
      // Category filter
      const matchesCategory = !category || item.category === category;
      
      // Stock filters
      const matchesMinStock = !minStock || item.available >= parseInt(minStock);
      const matchesMaxStock = !maxStock || item.available <= parseInt(maxStock);
      
      // Stock status filter
      let matchesStockStatus = true;
      if (stockStatus) {
        switch(stockStatus) {
          case 'low': matchesStockStatus = item.available < 10 && item.shippedT30 > 0; break;
          case 'high': matchesStockStatus = item.available > 100 && item.shippedT30 < 5; break;
          case 'stranded': matchesStockStatus = item.available > 10 && item.shippedT30 === 0; break;
        }
      }
      
      return matchesSearch && matchesCondition && matchesAction && matchesAge && 
             matchesCategory && matchesMinStock && matchesMaxStock && matchesStockStatus;
    });
    
    this.currentPage = 1;
    this.updateStats();
    this.renderTable();
    this.renderPagination();
  }

  resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('conditionFilter').value = '';
    document.getElementById('actionFilter').value = '';
    document.getElementById('ageFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('minStockFilter').value = '';
    document.getElementById('maxStockFilter').value = '';
    document.getElementById('stockStatusFilter').value = '';
    this.applyFilters();
  }

  getRowClass(item) {
    if (this.comparisonMode && this.comparisonData) {
      // Handle comparison mode row classes
      return this.getComparisonRowClass(item);
    }
    
    const classes = [];
    if (item.recommendedAction.toLowerCase().includes('removal')) classes.push('highlight');
    if (item.totalInvAge > 365) classes.push('status-warning');
    if (item.riskScore > 70) classes.push('status-at-risk');
    if (item.sellThroughRate > 70 && item.available > 0) classes.push('status-hot');
    return classes.join(' ');
  }

  getComparisonRowClass(item) {
    // In comparison mode, check differences between snapshots
    const classes = [];
    
    // This would compare with the other snapshot
    // For demo, showing static logic
    if (item.available > 50) classes.push('diff-increase');
    else if (item.available < 10) classes.push('diff-decrease');
    else classes.push('diff-unchanged');
    
    return classes.join(' ');
  }

  sortTable(column) {
    if (this.sortColumn === column) {
      this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      this.sortColumn = column;
      this.sortDirection = 'asc';
    }
    
    // Reset sort indicators
    document.querySelectorAll('th').forEach(th => {
      th.classList.remove('sort-asc', 'sort-desc');
    });
    
    // Set current sort indicator
    const header = document.querySelector(`th[data-sort="${column}"]`);
    if (header) {
      header.classList.add(this.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
    }
    
    // Sort the data
    this.filteredData.sort((a, b) => {
      let valA = a[column];
      let valB = b[column];
      
      // Handle numeric sorting
      if (typeof valA === 'number' && typeof valB === 'number') {
        return (valA - valB) * (this.sortDirection === 'asc' ? 1 : -1);
      }
      
      // Handle string sorting
      valA = String(valA).toLowerCase();
      valB = String(valB).toLowerCase();
      
      if (valA < valB) return this.sortDirection === 'asc' ? -1 : 1;
      if (valA > valB) return this.sortDirection === 'asc' ? 1 : -1;
      return 0;
    });
    
    this.renderTable();
    this.renderPagination();
  }

  renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    const start = (this.currentPage - 1) * this.itemsPerPage;
    const end = start + this.itemsPerPage;
    const pageData = this.filteredData.slice(start, end);
    
    if (pageData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="11" class="empty-state">‚ö†Ô∏è No products match your filters</td></tr>';
      return;
    }
    
    pageData.forEach(item => {
      const tr = document.createElement('tr');
      tr.className = this.getRowClass(item);
      tr.innerHTML = `
        <td class="sku-cell">${item.sku}</td>
        <td class="asin-cell">${item.asin}</td>
        <td class="product-cell">${item.name}</td>
        <td>${item.condition}</td>
        <td class="numeric-cell">${item.available.toLocaleString()}</td>
        <td class="numeric-cell">${item.pendingRemoval.toLocaleString()}</td>
        <td class="numeric-cell">${item.totalInvAge.toLocaleString()}</td>
        <td class="numeric-cell">${item.shippedT30.toLocaleString()}</td>
        <td class="numeric-cell">${item.sellThroughRate}%</td>
        <td><span class="status-badge ${item.recommendedAction.toLowerCase().includes('removal') ? 'status-recommendation' : item.totalInvAge > 365 ? 'status-warning-badge' : 'status-normal'}">${item.recommendedAction}</span></td>
        <td class="numeric-cell">${item.riskScore}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  renderPagination() {
    const container = document.getElementById('paginationContainer');
    container.innerHTML = '';
    
    const totalPages = Math.ceil(this.filteredData.length / this.itemsPerPage);
    if (totalPages <= 1) return;
    
    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.textContent = '‚Üê';
    prevBtn.className = 'page-btn';
    prevBtn.disabled = this.currentPage === 1;
    prevBtn.addEventListener('click', () => {
      if (this.currentPage > 1) {
        this.currentPage--;
        this.renderTable();
        this.renderPagination();
      }
    });
    container.appendChild(prevBtn);
    
    // Page numbers with ellipsis
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || 
          (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = `page-btn ${i === this.currentPage ? 'active' : ''}`;
        btn.addEventListener('click', () => {
          this.currentPage = i;
          this.renderTable();
          this.renderPagination();
        });
        container.appendChild(btn);
      } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
        const ellipsis = document.createElement('span');
        ellipsis.textContent = '...';
        ellipsis.style.padding = '0 8px';
        container.appendChild(ellipsis);
      }
    }
    
    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.textContent = '‚Üí';
    nextBtn.className = 'page-btn';
    nextBtn.disabled = this.currentPage === totalPages;
    nextBtn.addEventListener('click', () => {
      if (this.currentPage < totalPages) {
        this.currentPage++;
        this.renderTable();
        this.renderPagination();
      }
    });
    container.appendChild(nextBtn);
  }

  toggleComparisonMode() {
    if (Object.keys(this.snapshots).length < 2) {
      alert('Please upload at least 2 snapshots to enable comparison mode.');
      return;
    }
    
    this.comparisonMode = !this.comparisonMode;
    const comparisonView = document.getElementById('comparisonView');
    comparisonView.style.display = this.comparisonMode ? 'block' : 'none';
    
    if (this.comparisonMode) {
      // Load comparison data (simplified for demo)
      this.comparisonData = this.compareSnapshots();
      this.filteredData = this.comparisonData;
      document.getElementById('comparisonInfo').textContent = 'Comparing latest snapshots';
    } else {
      // Return to normal mode
      const snapshotNames = Object.keys(this.snapshots);
      if (snapshotNames.length > 0) {
        const latestSnapshot = snapshotNames[snapshotNames.length - 1];
        this.currentData = [...this.snapshots[latestSnapshot].data];
        this.filteredData = [...this.currentData];
      }
    }
    
    this.updateUI();
  }

  exitComparisonMode() {
    this.comparisonMode = false;
    document.getElementById('comparisonView').style.display = 'none';
    
    // Return to normal mode
    const snapshotNames = Object.keys(this.snapshots);
    if (snapshotNames.length > 0) {
      const latestSnapshot = snapshotNames[snapshotNames.length - 1];
      this.currentData = [...this.snapshots[latestSnapshot].data];
      this.filteredData = [...this.currentData];
    }
    
    this.updateUI();
  }

  compareSnapshots() {
    // Simplified comparison logic
    // In real implementation, this would compare two specific snapshots
    const snapshotNames = Object.keys(this.snapshots);
    if (snapshotNames.length < 2) return [];
    
    const snap1 = this.snapshots[snapshotNames[snapshotNames.length - 1]].data;
    const snap2 = this.snapshots[snapshotNames[snapshotNames.length - 2]].data;
    
    // Create comparison data
    return snap1.map(item => {
      const oldItem = snap2.find(old => old.sku === item.sku);
      if (oldItem) {
        return {
          ...item,
          inventoryChange: item.available - oldItem.available,
          shippedChange: item.shippedT30 - oldItem.shippedT30,
          ageChange: item.totalInvAge - oldItem.totalInvAge
        };
      }
      return item;
    });
  }

  showAlerts() {
    if (this.alerts.length === 0) {
      alert('No alerts found!');
      return;
    }
    
    const alertsText = this.alerts.map(alert => alert.message).join('\n\n');
    alert(`üö® WesBI Alerts:\n\n${alertsText}`);
  }

  exportData() {
    if (this.filteredData.length === 0) {
      alert('No data to export!');
      return;
    }
    
    const headers = Object.keys(this.filteredData[0]).filter(key => 
      !['timestamp', 'category'].includes(key)
    );
    const csvContent = [headers.join(',')];
    
    this.filteredData.forEach(row => {
      const rowValues = headers.map(header => {
        const value = row[header];
        if (typeof value === 'string' && value.includes(',')) {
          return `"${value.replace(/"/g, '""')}"`;
        }
        return value;
      });
      csvContent.push(rowValues.join(','));
    });
    
    const blob = new Blob([csvContent.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `wesbi_export_${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  exportChart(chartType) {
    // Chart export would be implemented here
    alert(`Export functionality for ${chartType} chart prepared for implementation.`);
  }

  filterByCard(filterType) {
    switch(filterType) {
      case 'pendingRemovals':
        document.getElementById('actionFilter').value = 'removal';
        break;
      case 'atRiskSKUs':
        // Apply filters for at-risk SKUs
        document.getElementById('ageFilter').value = '365+';
        break;
      case 'sellThroughRate':
        // This would filter by high sell-through
        break;
      default:
        // Reset filters
        this.resetFilters();
        return;
    }
    this.applyFilters();
  }
}

// Initialize the WesBI Beast Mode dashboard
const wesBI = new WesBIBeastMode();

// Handle drag and drop for file uploads
document.addEventListener('DOMContentLoaded', () => {
  const container = document.querySelector('.container');
  container.addEventListener('dragover', (e) => {
    e.preventDefault();
    container.style.borderColor = '#9c4dff';
  });
  
  container.addEventListener('dragleave', () => {
    container.style.borderColor = '';
  });
  
  container.addEventListener('drop', (e) => {
    e.preventDefault();
    container.style.borderColor = '';
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      const fileInput = document.getElementById('csvFile');
      fileInput.files = files;
      wesBI.showLoader(true, "Processing dropped files...");
      setTimeout(() => wesBI.processCSVs(), 100);
    }
  });
});
</script>
</body>
</html>
